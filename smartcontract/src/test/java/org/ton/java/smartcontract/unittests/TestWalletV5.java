package org.ton.java.smartcontract.unittests;
import com.iwebpp.crypto.TweetNaclFast;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.JUnit4;
import org.ton.java.address.Address;
import org.ton.java.cell.Cell;
import org.ton.java.cell.CellBuilder;
import org.ton.java.cell.TonHashMapE;
import org.ton.java.smartcontract.types.WalletV5Config;
import org.ton.java.smartcontract.utils.MsgUtils;
import org.ton.java.smartcontract.wallet.v5.WalletV5;
import org.ton.java.tlb.types.CurrencyCollection;
import org.ton.java.tlb.types.InternalMessageInfo;
import org.ton.java.tlb.types.Message;
import org.ton.java.tlb.types.MsgAddressIntStd;
import org.ton.java.tonlib.Tonlib;
import org.ton.java.utils.Utils;

import static org.junit.Assert.assertEquals;

@Slf4j
@RunWith(JUnit4.class)
public class TestWalletV5 {

    private static final String SECRET_KEY = "F182111193F30D79D517F2339A1BA7C25FDF6C52142F0F2C1D960A1F1D65E1E4";

    @Test
    public void testNewWalletV5() {
        byte[] secretKey = Utils.hexToSignedBytes(SECRET_KEY);
        TweetNaclFast.Signature.KeyPair keyPair = TweetNaclFast.Signature.keyPair_fromSeed(secretKey);

        WalletV5 contract = WalletV5.builder()
                .tonlib(Tonlib.builder().build())
                .wc(0)
                .walletId(43)
                .keyPair(keyPair)
                .extensions(new TonHashMapE(0))
                .build();

        String codeAsHex = contract.getStateInit().getCode().bitStringToHex();
        String dataAsHex = contract.getStateInit().getData().bitStringToHex();
        String rawAddress = contract.getAddress().toRaw();

        assertEquals("FF00F4A413F4BCF2C80B", codeAsHex);
        assertEquals("0000000000000015C150592A1E837F605564A974F639C5F2B558DB013FE060D540BD70A5A68F697DA_", dataAsHex);
        assertEquals("0:b259c80bc59f10f0a4dbe703c6311b2d259e12ed074f3ce9d7c285b20c7a50ef", rawAddress);

        Message msg = contract.prepareDeployMsg();
        log.info(msg.toString());

        // external message for serialization
        String expected = "880164B390178B3E21E149B7CE078C62365A4B3C25DA0E9E79D3AF850B6418F4A1DE119EBC3839D83BF100A86461668909F7D4D6D3C41669CDA49D0ED44A6999DD7F3972D352B99C39E3B58CF61FDCA0A142D9A335CFD99CC969DE85997BF45EAC6761000000057FFFFFFFE00000001_";
        String actual = msg.toCell().bitStringToHex();
        assertEquals(expected, actual);

        // external message in BoC format
        expected = "B5EE9C72410216010003200002DF880164B390178B3E21E149B7CE078C62365A4B3C25DA0E9E79D3AF850B6418F4A1DE119EBC3839D83BF100A86461668909F7D4D6D3C41669CDA49D0ED44A6999DD7F3972D352B99C39E3B58CF61FDCA0A142D9A335CFD99CC969DE85997BF45EAC6761000000057FFFFFFFE00000001001150114FF00F4A413F4BCF2C80B02020120030E020148040502DCD020D749C120915B8F6320D70B1F2082106578746EBD21821073696E74BDB0925F03E082106578746EBA8EB48020D72101D074D721FA4030FA44F828FA443058BD915BE0ED44D0810141D721F4058307F40E6FA1319130E18040D721707FDB3CE03120D749810280B99130E070E21110020120060D020120070A02016E08090019ADCE76A2684020EB90EB85FFC00019AF1DF6A2684010EB90EB858FC00201480B0C0017B325FB51341C75C875C2C7E00011B262FB513435C280200019BE5F0F6A2684080A0EB90FA02C0102F20F011E20D70B1F82107369676EBAF2E08A7F1001E68EF0EDA2EDFB218308D722028308D723208020D721D31FD31FD31FED44D0D200D31F20D31FD3FFD70A000AF90140CCF9109A28945F0ADB31E1F2C087DF02B35007B0F2D0845125BAF2E0855036BAF2E086F823BBF2D0882292F800DE01A47FC8CA00CB1F01CF16C9ED542092F80FDE70DB3CD81103F6EDA2EDFB02F404216E926C218E4C0221D73930709421C700B38E2D01D72820761E436C20D749C008F2E09320D74AC002F2E09320D71D06C712C2005230B0F2D089D74CD7393001A4E86C128407BBF2E093D74AC000F2E093ED55E2D20001C000915BE0EBD72C08142091709601D72C081C12E25210B1E30F20D74A121314009601FA4001FA44F828FA443058BAF2E091ED44D0810141D718F405049D7FC8CA0040048307F453F2E08B8E14038307F45BF2E08C22D70A00216E01B3B0F2D090E2C85003CF1612F400C9ED54007230D72C08248E2D21F2E092D200ED44D0D2005113BAF2D08F54503091319C01810140D721D70A00F2E08EE2C8CA0058CF16C9ED5493F2C08DE20010935BDB31E1D74CD000510000000000000015C150592A1E837F605564A974F639C5F2B558DB013FE060D540BD70A5A68F697DA04EB2F79C";
        actual = Utils.bytesToHex(msg.toCell().toBoc(true)).toUpperCase();
        assertEquals(expected, actual);
    }
}
